# 用户关联说明

## 问题：学生登录后显示"未找到学生信息"

### 原因
学生用户注册时，`user_id` 字段没有正确关联到学生表的学号（`sno`）。

### 解决方案

#### 方案1：注册时自动关联（推荐）
修改注册接口，如果注册的是学生，自动查找或创建学生记录并关联。

#### 方案2：手动关联（当前）
需要在数据库中手动设置 `user_id` 字段。

### 手动关联步骤

#### 1. 查找用户ID和学生学号
```sql
-- 查看用户表
SELECT id, username, role, user_id FROM users WHERE username = '李四';

-- 查看学生表
SELECT sno, name FROM Student WHERE name = '李四';
```

#### 2. 更新用户表的 user_id
```sql
-- 假设用户ID是1，学号是95001
UPDATE users SET user_id = 95001 WHERE id = 1 AND username = '李四';
```

### 使用 Django Shell 关联

```python
# 在 Django shell 中执行
python manage.py shell

from apps.student.models import User, Student

# 查找用户
user = User.objects.get(username='李四')

# 查找学生（根据姓名或学号）
student = Student.objects.filter(name='李四').first()
# 或者
student = Student.objects.filter(sno=95001).first()

# 关联
if student:
    user.user_id = student.sno
    user.save()
    print(f"用户 {user.username} 已关联到学号 {student.sno}")
else:
    print("未找到对应的学生记录")
```

### 批量关联所有学生用户

```python
# 在 Django shell 中执行
from apps.student.models import User, Student

# 获取所有学生角色的用户
student_users = User.objects.filter(role='student')

for user in student_users:
    # 尝试根据用户名查找学生
    student = Student.objects.filter(name=user.username).first()
    
    if not student:
        # 如果用户名不匹配，尝试查找所有学生，手动匹配
        print(f"用户 {user.username} 未找到匹配的学生记录")
        continue
    
    # 关联
    user.user_id = student.sno
    user.save()
    print(f"用户 {user.username} 已关联到学号 {student.sno}")
```

### 创建测试数据

#### 创建学生用户并关联
```python
from apps.student.models import User, Student
import bcrypt

# 1. 确保学生表中存在该学生
student = Student.objects.filter(sno=95001).first()
if not student:
    # 创建学生记录
    student = Student.objects.create(
        sno=95001,
        name='李四',
        gender='男',
        birthday='2000-01-01',
        mobile='13800138000',
        email='lisi@example.com',
        address='北京市'
    )

# 2. 创建用户并关联
hashed_password = bcrypt.hashpw('123456'.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
user, created = User.objects.get_or_create(
    username='李四',
    defaults={
        'password': hashed_password,
        'role': 'student',
        'user_id': student.sno
    }
)

if not created:
    # 如果用户已存在，更新关联
    user.user_id = student.sno
    user.save()

print(f"用户 {user.username} 已关联到学号 {student.sno}")
```

### 验证关联

```python
from apps.student.models import User, Student

user = User.objects.get(username='李四')
if user.user_id:
    student = Student.objects.filter(sno=user.user_id).first()
    if student:
        print(f"✓ 关联成功：用户 {user.username} -> 学号 {student.sno} ({student.name})")
    else:
        print(f"✗ 关联失败：user_id={user.user_id} 对应的学生不存在")
else:
    print(f"✗ 用户 {user.username} 的 user_id 未设置")
```
