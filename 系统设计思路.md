# 系统重构设计思路

## 一、数据库设计

### 1. 现有表结构
- **User 表**：用户登录表（username, password）
- **Student 表**：学生信息表（sno, name, gender, birthday, mobile, email, address, image）

### 2. 需要新增/修改的表

#### 2.1 修改 User 表
```sql
ALTER TABLE User ADD COLUMN role VARCHAR(20) DEFAULT 'student';  -- 角色：student/teacher
ALTER TABLE User ADD COLUMN user_id INT;  -- 关联到学生或教师的ID
```

#### 2.2 新增 Teacher 表
```sql
CREATE TABLE Teacher (
    id INT PRIMARY KEY AUTO_INCREMENT,
    teacher_no VARCHAR(20) UNIQUE NOT NULL,  -- 工号
    name VARCHAR(100) NOT NULL,  -- 姓名
    age INT,  -- 年龄
    gender VARCHAR(10),  -- 性别
    mobile VARCHAR(20),  -- 手机
    email VARCHAR(100),  -- 邮箱
    department VARCHAR(100),  -- 部门
    title VARCHAR(50),  -- 职称
    hire_date DATE,  -- 入职日期
    description TEXT,  -- 个人简介
    avatar VARCHAR(200)  -- 头像
);
```

#### 2.3 新增 Leave 表（请假表）
```sql
CREATE TABLE Leave (
    id INT PRIMARY KEY AUTO_INCREMENT,
    student_id INT NOT NULL,  -- 学生ID（关联Student.sno）
    student_name VARCHAR(100),  -- 学生姓名（冗余字段，方便查询）
    student_no VARCHAR(20),  -- 学号（冗余字段）
    leave_type VARCHAR(20) NOT NULL,  -- 请假类型：事假/病假/其他
    start_date DATE NOT NULL,  -- 开始日期
    end_date DATE NOT NULL,  -- 结束日期
    days INT NOT NULL,  -- 请假天数
    reason TEXT NOT NULL,  -- 请假原因
    status VARCHAR(20) DEFAULT 'pending',  -- 状态：pending/approved/rejected
    apply_time DATETIME NOT NULL,  -- 申请时间
    teacher_id INT,  -- 审批教师ID（关联Teacher.id）
    approval_comment TEXT,  -- 审批意见
    approval_time DATETIME  -- 审批时间
);
```

#### 2.4 修改 Student 表（可选）
```sql
ALTER TABLE Student ADD COLUMN user_id INT;  -- 关联到User表
```

## 二、登录逻辑迁移方案

### 方案：在 Django 中实现与 Flask 相同的登录接口

**优势：**
- 前端代码完全不需要修改
- 保持 API 接口格式一致
- 可以逐步迁移，不影响现有功能

### 实现步骤：

1. **在 Django 中创建登录视图**
   - 路径：`/api/login`（与 Flask 保持一致）
   - 返回格式：`{'code': 200, 'msg': '登录成功', 'access_token': ..., 'refresh_token': ...}`
   - 使用相同的 JWT 生成逻辑

2. **JWT 配置**
   - 使用相同的 SECRET_KEY
   - 使用相同的算法和过期时间

3. **密码验证**
   - Flask 使用 bcrypt，Django 也需要使用 bcrypt 或 Django 的密码哈希
   - 需要兼容 Flask 中已加密的密码

## 三、功能设计

### 1. 用户角色管理
- **学生（student）**：可以申请请假、查看自己的请假记录
- **教师（teacher）**：可以审批请假、查看所有请假记录

### 2. 前端菜单权限控制
根据用户角色显示不同菜单：
- **学生菜单**：
  - 学生信息（查看自己的信息）
  - 我的请假申请（申请请假、查看申请记录）
  
- **教师菜单**：
  - 教师信息
  - 请假管理（审批请假）
  - 学生信息（查看所有学生）
  - 图像信息

### 3. 请假流程
1. **学生申请请假**
   - 填写请假表单（类型、日期、原因）
   - 提交后状态为 `pending`

2. **教师审批请假**
   - 查看待审批的请假列表
   - 可以批准或拒绝
   - 可以填写审批意见

## 四、API 接口设计

### 登录相关（迁移到 Django）
- `POST /api/login` - 登录
- `POST /api/register` - 注册
- `POST /api/refresh` - 刷新 token

### 请假相关（新增）
- `GET /leaves/` - 获取请假列表（根据角色返回不同数据）
- `POST /leave/apply/` - 学生申请请假
- `POST /leave/approve/` - 教师批准请假
- `POST /leave/reject/` - 教师拒绝请假
- `GET /leave/detail/<id>/` - 获取请假详情
- `POST /leave/delete/` - 删除请假记录

### 教师相关（新增）
- `GET /teacher/info/` - 获取当前登录教师信息
- `POST /teacher/update/` - 更新教师信息

## 五、实现步骤

### 第一步：数据库迁移
1. 修改 User 模型，添加 role 和 user_id 字段
2. 创建 Teacher 模型
3. 创建 Leave 模型
4. 生成并执行迁移

### 第二步：登录逻辑迁移
1. 在 Django 中创建登录视图
2. 实现 JWT token 生成（与 Flask 保持一致）
3. 实现密码验证（兼容 Flask 的 bcrypt）
4. 测试登录功能

### 第三步：请假功能实现
1. 创建请假相关的视图函数
2. 实现学生申请请假
3. 实现教师审批请假
4. 实现请假列表查询（根据角色过滤）

### 第四步：前端功能完善
1. 根据用户角色显示不同菜单
2. 创建学生请假申请组件
3. 完善教师审批组件（已有，需要连接真实接口）

## 六、注意事项

1. **保持现有功能不变**
   - 所有现有的学生管理功能保持不变
   - 所有现有的 API 接口保持不变

2. **密码兼容性**
   - Flask 使用 bcrypt，Django 需要能够验证 Flask 加密的密码
   - 或者统一迁移到 Django 的密码哈希系统

3. **JWT Token 兼容**
   - 保持相同的 SECRET_KEY
   - 保持相同的 token 格式和过期时间

4. **数据库兼容**
   - 新增字段使用默认值，不影响现有数据
   - 新表独立，不影响现有表结构
