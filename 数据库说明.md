# 数据库说明文档

## 一、数据库位置和连接信息

### Django 后端使用的数据库

**数据库类型：** MySQL  
**数据库名称：** `studentv4db`  
**主机地址：** `localhost` (127.0.0.1)  
**端口：** `3306`  
**用户名：** `root`  
**密码：** `Waxbz12593q123.`

**配置文件位置：** `StudentV4BE/StudentV4BE/settings.py`

### Flask 后端使用的数据库（旧系统，已迁移）

**数据库类型：** MySQL  
**数据库名称：** `student_mgmt`  
**主机地址：** `localhost`  
**端口：** `3306`  
**用户名：** `root`  
**密码：** `Waxbz12593q123.`

**配置文件位置：** `PersonlWeb/StudentV4FE/Student-mgmt-backend/config.py`

## 二、数据库表结构

### 1. Student 表（学生表）

**表名：** `Student`

**字段说明：**
| 字段名（数据库） | 字段名（模型） | 类型 | 说明 |
|----------------|--------------|------|------|
| SNo | sno | INTEGER | 学号（主键） |
| SName | name | VARCHAR(100) | 姓名 |
| Gender | gender | VARCHAR(100) | 性别（男/女） |
| Birthday | birthday | DATE | 出生日期 |
| Mobile | mobile | VARCHAR(100) | 手机号码 |
| Email | email | VARCHAR(100) | 邮箱地址 |
| Address | address | VARCHAR(200) | 家庭住址 |
| Image | image | VARCHAR(200) | 照片路径 |

### 2. users 表（用户登录表）

**表名：** `users`

**字段说明：**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键（自增） |
| username | VARCHAR(50) | 用户名（唯一） |
| password | VARCHAR(100) | 密码（bcrypt加密） |
| role | VARCHAR(20) | 角色（student/teacher） |
| user_id | INTEGER | 关联ID（学生学号或教师ID） |

**重要：**
- `role` 字段：`student`（学生）或 `teacher`（教师）
- `user_id` 字段：
  - 如果是学生：关联到 `Student` 表的 `SNo`（学号）
  - 如果是教师：关联到 `Teacher` 表的 `id`

### 3. Teacher 表（教师表）

**表名：** `Teacher`

**字段说明：**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键（自增） |
| teacher_no | VARCHAR(20) | 工号（唯一） |
| name | VARCHAR(100) | 姓名 |
| age | INTEGER | 年龄 |
| gender | VARCHAR(10) | 性别（男/女） |
| mobile | VARCHAR(20) | 手机号码 |
| email | VARCHAR(100) | 邮箱地址 |
| department | VARCHAR(100) | 所属部门 |
| title | VARCHAR(50) | 职称（助教/讲师/副教授/教授） |
| hire_date | DATE | 入职日期 |
| description | TEXT | 个人简介 |
| avatar | VARCHAR(200) | 头像路径 |

### 4. Leave 表（请假表）

**表名：** `Leave`

**字段说明：**
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键（自增） |
| student_id | INTEGER | 学生ID（关联Student.SNo） |
| student_name | VARCHAR(100) | 学生姓名（冗余字段） |
| student_no | VARCHAR(20) | 学号（冗余字段） |
| leave_type | VARCHAR(20) | 请假类型（事假/病假/其他） |
| start_date | DATE | 开始日期 |
| end_date | DATE | 结束日期 |
| days | INTEGER | 请假天数 |
| reason | TEXT | 请假原因 |
| status | VARCHAR(20) | 状态（pending/approved/rejected） |
| apply_time | DATETIME | 申请时间 |
| teacher_id | INTEGER | 审批教师ID（关联Teacher.id） |
| approval_comment | TEXT | 审批意见 |
| approval_time | DATETIME | 审批时间 |

## 三、如何查看数据库

### 方法1：使用 MySQL 命令行

```bash
# 连接 MySQL
mysql -u root -p
# 输入密码：Waxbz12593q123.

# 查看所有数据库
SHOW DATABASES;

# 使用数据库
USE studentv4db;

# 查看所有表
SHOW TABLES;

# 查看表结构
DESCRIBE Student;
DESCRIBE users;
DESCRIBE Teacher;
DESCRIBE Leave;

# 查看数据
SELECT * FROM users;
SELECT * FROM Student;
SELECT * FROM Teacher;
SELECT * FROM Leave;
```

### 方法2：使用 MySQL Workbench

1. 打开 MySQL Workbench
2. 创建新连接：
   - Hostname: `localhost`
   - Port: `3306`
   - Username: `root`
   - Password: `Waxbz12593q123.`
3. 连接后，在左侧选择数据库 `studentv4db`
4. 展开 Tables，可以看到所有表

### 方法3：使用 Navicat 或其他数据库管理工具

1. 创建新连接
2. 填写连接信息（同上）
3. 连接到 `studentv4db` 数据库

### 方法4：使用 Django Shell

```bash
cd StudentV4BE
python manage.py shell

# 查看所有用户
from apps.student.models import User
User.objects.all()

# 查看所有学生
from apps.student.models import Student
Student.objects.all()

# 查看所有教师
from apps.student.models import Teacher
Teacher.objects.all()

# 查看所有请假记录
from apps.student.models import Leave
Leave.objects.all()
```

## 四、常见 SQL 查询

### 查看所有用户及其角色
```sql
SELECT id, username, role, user_id FROM users;
```

### 查看学生及其关联的用户
```sql
SELECT s.SNo, s.SName, u.username, u.role, u.user_id
FROM Student s
LEFT JOIN users u ON s.SNo = u.user_id;
```

### 查看教师及其关联的用户
```sql
SELECT t.id, t.teacher_no, t.name, u.username, u.role, u.user_id
FROM Teacher t
LEFT JOIN users u ON t.id = u.user_id;
```

### 查看请假记录及其学生信息
```sql
SELECT l.*, s.SName as student_name
FROM Leave l
LEFT JOIN Student s ON l.student_id = s.SNo;
```

### 关联学生用户（修复"未找到学生信息"问题）
```sql
-- 假设用户名是"李四"，学号是95001
UPDATE users 
SET user_id = 95001 
WHERE username = '李四' AND role = 'student';
```

## 五、数据库迁移

如果表不存在，需要执行迁移：

```bash
cd StudentV4BE
python manage.py makemigrations
python manage.py migrate
```

## 六、注意事项

1. **数据库名称：** Django 使用 `studentv4db`，Flask 使用 `student_mgmt`（已迁移）
2. **表名大小写：** MySQL 在 Windows 上默认不区分大小写，但建议保持一致
3. **user_id 关联：** 学生用户的 `user_id` 必须关联到 `Student` 表的 `SNo`（学号）
4. **教师关联：** 教师用户的 `user_id` 必须关联到 `Teacher` 表的 `id`
