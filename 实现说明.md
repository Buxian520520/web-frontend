# 系统实现说明

## 一、已完成的功能

### 1. 数据库模型扩展
- ✅ 扩展 User 模型：添加 `role`（角色）和 `user_id`（关联ID）字段
- ✅ 创建 Teacher 模型：存储教师信息
- ✅ 创建 Leave 模型：存储请假记录

### 2. 登录逻辑迁移
- ✅ 在 Django 中实现 `/api/login` 接口（与 Flask 保持一致）
- ✅ 在 Django 中实现 `/api/register` 接口
- ✅ 在 Django 中实现 `/api/refresh` 接口
- ✅ 使用相同的 JWT 生成逻辑和 SECRET_KEY
- ✅ 兼容 Flask 的 bcrypt 密码加密

### 3. 请假功能后端接口
- ✅ `GET /leaves/` - 获取请假列表（根据角色返回不同数据）
- ✅ `POST /leave/apply/` - 学生申请请假
- ✅ `POST /leave/approve/` - 教师批准请假
- ✅ `POST /leave/reject/` - 教师拒绝请假
- ✅ `GET /leave/detail/<id>/` - 获取请假详情
- ✅ `POST /leave/delete/` - 删除请假记录

### 4. 教师管理接口
- ✅ `GET /teacher/info/` - 获取当前登录教师信息
- ✅ `POST /teacher/update/` - 更新教师信息

### 5. 前端组件
- ✅ 学生请假申请组件（StudentLeave.js）
- ✅ 教师请假管理组件（LeaveManage.js）- 已连接真实接口
- ✅ 教师信息组件（TeacherInfo.js）- 已连接真实接口
- ✅ 角色菜单控制（根据用户角色显示不同菜单）

## 二、需要执行的步骤

### 1. 安装依赖
```bash
# 进入 Django 项目目录
cd StudentV4BE

# 安装 bcrypt（如果未安装）
pip install bcrypt
```

### 2. 数据库迁移
```bash
# 生成迁移文件
python manage.py makemigrations

# 执行迁移
python manage.py migrate
```

### 3. 更新前端登录地址
前端登录地址已自动更新为 Django 后端地址（`http://127.0.0.1:8000/api/login`）

### 4. 创建测试数据

#### 创建学生用户
```python
# 在 Django shell 中执行
python manage.py shell

from apps.student.models import User, Student
import bcrypt

# 创建学生用户
hashed_password = bcrypt.hashpw('123456'.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
student_user = User.objects.create(
    username='student1',
    password=hashed_password,
    role='student',
    user_id=95001  # 关联到学生表的学号
)

# 确保学生表中存在该学号的学生
```

#### 创建教师用户
```python
from apps.student.models import User, Teacher
import bcrypt

# 创建教师
teacher = Teacher.objects.create(
    teacher_no='T001',
    name='张老师',
    age=35,
    gender='男',
    mobile='13800138000',
    email='teacher@example.com',
    department='计算机科学系',
    title='讲师'
)

# 创建教师用户
hashed_password = bcrypt.hashpw('123456'.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
teacher_user = User.objects.create(
    username='teacher1',
    password=hashed_password,
    role='teacher',
    user_id=teacher.id  # 关联到教师表的ID
)
```

## 三、API 接口说明

### 认证方式
所有需要认证的接口都需要在请求头中添加：
```
Authorization: Bearer <access_token>
```

### 接口列表

#### 登录相关
- `POST /api/login` - 登录（已迁移到 Django）
- `POST /api/register` - 注册（已迁移到 Django）
- `POST /api/refresh` - 刷新 Token（已迁移到 Django）

#### 请假相关
- `GET /leaves/` - 获取请假列表
  - 学生：只能查看自己的请假记录
  - 教师：可以查看所有请假记录
  - 查询参数：`student_name`（学生姓名）、`status`（状态）

- `POST /leave/apply/` - 申请请假（仅学生）
  ```json
  {
    "leaveType": "事假",
    "startDate": "2024-01-15",
    "endDate": "2024-01-17",
    "reason": "家中有事"
  }
  ```

- `POST /leave/approve/` - 批准请假（仅教师）
  ```json
  {
    "leaveId": 1,
    "comment": "同意"
  }
  ```

- `POST /leave/reject/` - 拒绝请假（仅教师）
  ```json
  {
    "leaveId": 1,
    "comment": "理由不充分"
  }
  ```

- `GET /leave/detail/<id>/` - 获取请假详情

- `POST /leave/delete/` - 删除请假记录
  ```json
  {
    "leaveIds": [1, 2, 3]
  }
  ```

#### 教师相关
- `GET /teacher/info/` - 获取教师信息（仅教师）
- `POST /teacher/update/` - 更新教师信息（仅教师）

## 四、前端菜单权限

### 学生菜单
- 学生信息
- 我的请假申请

### 教师菜单
- 班级管理
- 学生信息
- 讲师信息
- 课程管理
- 图像信息
- 请假管理

## 五、注意事项

1. **密码兼容性**
   - Django 使用 bcrypt 验证密码，与 Flask 保持一致
   - 如果现有用户密码是明文，需要重新设置密码

2. **JWT Token**
   - Token 中包含 `role` 字段，用于前端权限控制
   - Token 格式与 Flask 保持一致

3. **数据库兼容**
   - 新增字段使用默认值，不影响现有数据
   - 新表独立，不影响现有表结构

4. **现有功能**
   - 所有现有功能保持不变
   - 所有现有 API 接口保持不变

## 六、测试建议

1. 测试登录功能（使用 Django 接口）
2. 测试学生申请请假
3. 测试教师审批请假
4. 测试角色菜单显示
5. 测试教师信息管理
